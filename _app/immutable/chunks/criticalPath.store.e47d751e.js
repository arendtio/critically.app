var b=(a,e,r)=>{if(!e.has(a))throw TypeError("Cannot "+r)};var o=(a,e,r)=>(b(a,e,"read from private field"),r?r.call(a):e.get(a)),u=(a,e,r)=>{if(e.has(a))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(a):e.set(a,r)},S=(a,e,r,t)=>(b(a,e,"write to private field"),t?t.call(a,r):e.set(a,r),r);var g=(a,e,r)=>(b(a,e,"access private method"),r);import{w as $}from"./index.9f5fd596.js";import{g as G}from"./tables.store.38b25df8.js";import{E as H}from"./scheduler.d96d3362.js";var n,w,d,x,T,F,v,C,P,L,j,A;class J{constructor(){u(this,T);u(this,v);u(this,P);u(this,j);u(this,n,void 0);u(this,w,[]);u(this,d,[]);u(this,x,void 0);S(this,n,new Map),S(this,x,new Map)}addTask(e,r,t,s,c,i,h,E,l=null,p=null){if(t=M(t),s=M(s),c=M(c),isNaN(t)||isNaN(s)||isNaN(c))throw new Error(`Invalid duration values for task "${e}": min=${t}, likely=${s}, max=${c}`);i=i.split(",").map(f=>f.split("&").map(_=>_.trim()));let m=h.split(",").map(f=>f.trim()).filter(f=>f!=="");m.forEach(f=>{if(f===e.toString())throw new Error(`Task "${e}" cannot have itself as a predecessor.`)}),l&&!isNaN(new Date(l).getTime())?l=l:l=null,p&&!isNaN(new Date(p).getTime())?p=p:p=null;let N=Math.round((t+s*4+c)/6),z={id:e,name:r,min:t,likely:s,max:c,res:i,resIdList:[],predecessors:new Set(m),successors:new Set,progress:E,earlyCol:1,es:0,ef:0,ls:0,lf:0,slack:-1,expected:N,startDate:l,endDate:p};o(this,n).set(e,z)}getTask(e){return o(this,n).get(e)}calc(){return g(this,T,F).call(this),g(this,P,L).call(this),g(this,j,A).call(this),{starts:o(this,w),map:Object.fromEntries(o(this,n)),ends:o(this,d)}}}n=new WeakMap,w=new WeakMap,d=new WeakMap,x=new WeakMap,T=new WeakSet,F=function(){o(this,n).forEach(e=>{e.predecessors.forEach(r=>{if(!o(this,n).has(r))throw new Error(`Task "${e.id}" references predecessor "${r}" which does not exist.`)})}),o(this,n).forEach(e=>{e.predecessors.forEach(r=>{o(this,n).get(r).successors.add(e.id)})}),S(this,w,[...o(this,n).values()].filter(e=>e.predecessors.size===0).map(e=>e.id)),S(this,d,[...o(this,n).values()].filter(e=>e.successors.size===0).map(e=>e.id))},v=new WeakSet,C=function(e,r,t,s){if(t.has(e))return;t.add(e);let c=o(this,n).get(e);c[r].forEach(i=>{g(this,v,C).call(this,i,r,t,s)}),c=s(c),o(this,n).set(c.id,c)},P=new WeakSet,L=function(){let e=new Set;o(this,d).forEach(r=>{g(this,v,C).call(this,r,"predecessors",e,t=>{let s=[...t.predecessors].map(i=>o(this,n).get(i)).reduce((i,h)=>i<h.ef?h.ef:i,0),c=[...t.predecessors].map(i=>o(this,n).get(i)).reduce((i,h)=>i<h.earlyCol?h.earlyCol:i,0);return t.earlyCol=c+1,t.es=s+1,t.ef=t.es+t.expected-1,t})})},j=new WeakSet,A=function(){let e=Math.max(...o(this,d).map(t=>o(this,n).get(t).ef)),r=new Set;o(this,w).forEach(t=>{g(this,v,C).call(this,t,"successors",r,s=>{let c=[...s.successors].map(i=>o(this,n).get(i)).reduce((i,h)=>i<h.ls?i:h.ls,e+1);return s.lf=c-1,s.ls=s.lf-s.expected+1,s.slack=s.ls-s.es,s})})};const y=$({}),O=$(void 0);function M(a,e){e===void 0&&(e=navigator.languages&&navigator.languages.length?navigator.languages[0]:navigator.language);let[,r,,,,t]=1111.1.toLocaleString(e);return a=Array.from(""+a,s=>s===r?"":s===t?".":s).join(""),parseFloat(a)}y.reset=()=>y.set({});O.reset=()=>O.set(void 0);y.calculate=function(){O.set(void 0);let a;G("tasks").update(l=>(a=l,l));let r=new J,t=[];if(a.getAllIds().forEach(l=>{let p=a.getRow(l);try{const m=a.getLevelColumnName(),N=a.getHeader().indexOf(m);N!==-1&&(p=[...p.slice(0,N),...p.slice(N+1)]),r.addTask(...p)}catch(m){t.push(m.message)}}),t.length>0){const l=`Please fix the following issues:

`+t.join(`
`);alert(l);return}console.log("Starting calculation");let s;try{s=r.calc()}catch(l){alert("Error during critical path calculation: "+l.message);return}let c=new Map;for(var i in s.map)if(Object.prototype.hasOwnProperty.call(s.map,i)){let l=s.map[i];l.predecessors=[...l.predecessors],c.set(l.id,l)}s.map=Object.fromEntries(c);const E=H(y).map||{};Object.keys(s.map).forEach(l=>{E[l]&&(s.map[l].x=E[l].x,s.map[l].y=E[l].y)}),console.log("Final positions after preservation:",s.map),console.log("Finished calculation: ",JSON.stringify(s)),y.set(s)};export{y as c,O as d,M as l};
