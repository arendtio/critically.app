import{w as f}from"./index.6deb0bed.js";import{g as _}from"./tables.store.60936c52.js";import{p as u}from"./projectCharter.store.e87999d8.js";import{N as b}from"./scheduler.8fe615de.js";class R{constructor(){this.apiKey="",this.mediaRecorder=null,this.audioChunks=[],this.playbackAudio=null}setApiKey(t){console.log("new api key was set:",t),this.apiKey=t}async record(){if(this.apiKey=="")throw new Error("Api key not set");const t=await navigator.mediaDevices.getUserMedia({audio:!0});this.mediaRecorder=new MediaRecorder(t),this.mediaRecorder.ondataavailable=s=>{this.audioChunks.push(s.data)};let o=new Promise((s,l)=>{this.mediaRecorder.onstop=async()=>{s()}});return this.mediaRecorder.start(),o}async transcribe(){if(this.apiKey=="")throw new Error("Api key not set");const t=new Blob(this.audioChunks,{type:"audio/wav"}),o=new File([t],"recording.wav"),s=new FormData;s.append("file",o),s.append("model","whisper-1");const r=(await(await fetch("https://api.openai.com/v1/audio/transcriptions",{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`},body:s})).json()).text;return console.log("Transkribierter Text:",r),r}stopRecording(){this.mediaRecorder&&(this.mediaRecorder.stop(),this.audioChunks=[])}stopPlayback(){if(console.log("stopping audio playback"),this.playbackAudio){this.playbackAudio.pause();const t=this.playbackAudio;this.playbackAudio=null,t.onended&&t.onended()}}stop(){this.stopRecording()}async sendToGPT(t,o){if(this.apiKey=="")throw new Error("Api key not set");const s={model:"gpt-4o-mini",messages:t,tools:o};return(await(await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify(s)})).json()).choices[0]}async speak(t){if(this.apiKey=="")throw new Error("Api key not set");const s=await(await fetch("https://api.openai.com/v1/audio/speech",{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({input:t,model:"tts-1",voice:"shimmer"})})).blob(),l=URL.createObjectURL(s),e=new Audio(l);return this.playbackAudio=e,new Promise(r=>{e.onended=()=>{console.log("audio playback ended, revoking URL"),URL.revokeObjectURL(l),this.playbackAudio=null,r("completed")},e.addEventListener("canplaythrough",()=>{e.play().catch(n=>{console.error("Error playing audio:",n),this.playbackAudio=null,r("error")})})})}async generateTasks(t,o){console.log("Starting generate Tasks");let s=JSON.stringify(o);t.push({role:"developer",content:`This is the current task table as JSON (Array containing the rows of the table, starting with the headings):
`+s}),t.push({role:"developer",content:"Update the given task table based on the information of the last messages of the conversation. The headings should be the same. Answer just with an JSON string without any other text. Your answer must be parsable with JSON.parse(), so not even Markdown code blocks should be included."});let l=await this.sendToGPT(t);return JSON.parse(l)}async generateRessources(t,o){}}const T=f([]);function O(a){T.update(t=>[...t,{id:Date.now(),text:a,timestamp:new Date().toISOString()}])}function U(a){T.update(t=>t.filter(o=>o.id!==a))}var d=new R,D=50;const v=[{role:"developer",content:"You are a helpful assistant for Project Management integrated into a Project Management Software. Keep your answers very short. Ask questions if something important. Make useful assumptions when something is undefined."},{role:"developer",content:"Ensure that a complete project charter exists. If not, suggest to the user to complete it first, but accept to proceed if the user insists."},{role:"developer",content:"In general, make useful assumptions, but also ask questions to clarify, get more details regarding a recent action or to define the fundamentals (e.g. project charter)."},{role:"developer",content:"Use tools to plan the project. At least every "+(D-2)+" tool roundtrips you have to respond with a message to the user."},{role:"developer",content:"Dates must use the format YYYY-MM-DD."},{role:"developer",content:"You can add or remove AI suggestions for project improvement. Use the manage_suggestions tool to do so, at regular intervals."},{role:"developer",content:"Respond to the user in its prefered language. The browser tells us, that the user preferes the following language: "+(navigator.language||navigator.userLanguage)}],i=f({isRecording:!1,isThinking:!1,isSpeaking:!1,status:"idle"}),P=f();function x(){const{subscribe:a,set:t,update:o}=f(v);return{subscribe:a,set:t,update:o,reset:()=>t(v)}}const g=x();let m=[];g.subscribe(a=>m=a);let y=_("tasks"),j;y.subscribe(a=>j=a);let w=_("resources"),S;w.subscribe(a=>S=a);const I=[{type:"function",strict:!0,function:{name:"update_project_charter",description:"Update the project charter with new information or assumptions",parameters:{type:"object",properties:{field:{type:"string",description:"The field to update in the project charter",enum:["projectName","projectDescription","projectManager","startDate","endDate","objectives","stakeholders","scope","assumptions","constraints","risks","budget","success_criteria","key_deliverables"]},value:{oneOf:[{type:"string",description:"Value for single-value fields like projectName, description, dates, etc."},{type:"array",description:"Value for array fields like objectives, stakeholders, etc.",items:{type:"string"}},{type:"object",description:"Value for object fields like scope and budget",properties:{inScope:{type:"array",items:{type:"string"}},outOfScope:{type:"array",items:{type:"string"}},amount:{type:"number"},currency:{type:"string"}}}]},is_assumption:{type:"boolean",description:"Whether this value is an assumption made by the assistant (true) or information provided by the user (false)"}},required:["field","value","is_assumption"],additionalProperties:!1}}},{type:"function",strict:!0,function:{name:"operate_on_table",description:"",parameters:{type:"object",properties:{table_name:{type:"string",description:"Name of the table to be operated upon",enum:["tasks","resources"]},operation:{type:"string",description:"What operation should be performed on the table. For add_or_replace_row/add_or_replace_column, content must be an array of values for the entire row/column (including the id or heading).",enum:["add_or_replace_row","delete_row","clear_table","add_or_replace_column"]},id:{type:"string",description:"Unique identifier of the row/column that should be affected by the operation. For add_or_replace_column, this is the column header name."},content:{type:"array",description:"The content of one row/column of the table. It should be represented as an array of strings, which represent the columns/rows. The columns are defined by the header of the existing table. In any case, it must contain complete rows/columns and include the id or heading respectively and match the number of columns/rows of the existing table. The first value of the array must be the id or heading.",items:{type:"string"}}},required:["table_name","operation"],additionalProperties:!1}}},{type:"function",strict:!0,function:{name:"rename_heading",description:"Rename a single column heading in a table",parameters:{type:"object",properties:{table_name:{type:"string",description:"Name of the table to be operated upon",enum:["tasks","resources"]},old_heading:{type:"string",description:"The current name of the heading to be renamed"},new_heading:{type:"string",description:"The new name for the heading"}},required:["table_name","old_heading","new_heading"],additionalProperties:!1}}},{type:"function",strict:!0,function:{name:"manage_suggestions",description:"Add or remove AI suggestions for project improvement. Use this to provide dynamic suggestions based on the project state and conversation context.",parameters:{type:"object",properties:{action:{type:"string",enum:["add","remove"],description:"Whether to add a new suggestion or remove an existing one"},suggestion:{type:"string",description:"For 'add': The suggestion text to add. For 'remove': The suggestion ID to remove"},reason:{type:"string",description:"The reasoning behind adding or removing this suggestion"}},required:["action","suggestion"]}}}];function J(a){let t=[];return a.forEach(o=>{let s=o.function,l=o.id,e=JSON.parse(s.arguments),r;if(s.name==="update_project_charter"){if(b(u)||u.initialize(),u.updateField(e.field,e.value),e.is_assumption){const n=b(u).assumptions||[],h=`Assumed ${e.field}: ${JSON.stringify(e.value)}`;n.includes(h)||u.updateField("assumptions",[...n,h])}}else if(s.name==="operate_on_table"){switch(e.table_name){case"tasks":r=y;break;case"resources":r=w;break;default:throw console.error("Undefined table_name was requested:",s.name,e),new Error("Undefined table_name was requested.")}switch(e.operation){case"add_or_replace_row":r.update(n=>(n.add_or_replace_row(e.content[0],e.content),n));break;case"delete_row":console.log("operation",e.operation,e),r.update(n=>(console.log("Update t",n),n.delete_row(e.id),n));break;case"clear_table":console.log("operation",e.operation,e),r.update(n=>(console.log("Update t",n),n.clear_table(),n));break;case"add_or_replace_column":console.log("operation",e.operation,e),r.update(n=>(console.log("Update t",n),n.add_or_replace_column(e.id,e.content),n));break;default:throw new Error("Undefined tool operation was called:",s.name,e)}}else if(s.name==="rename_heading"){switch(console.log("operation rename_heading",e),e.table_name){case"tasks":r=y;break;case"resources":r=w;break;default:throw console.error("Undefined table_name was requested:",s.name,e),new Error("Undefined table_name was requested.")}r.update(n=>{console.log("Update t",n);const c=n.getHeader().map(p=>p===e.old_heading?e.new_heading:p);return n.changeHeadings(c),n})}else if(s.name==="manage_suggestions")e.action==="add"?O(e.suggestion):e.action==="remove"&&U(e.suggestion);else throw new Error("Undefined tool function was called:",s.name);t.push({role:"tool",content:"success",tool_call_id:l})}),t}async function A(a){var s,l;let t=null,o=0;for(;t==null&&o<10;){const e=b(u);let r=JSON.parse(JSON.stringify(a));e?r.push({role:"developer",content:`Project context from charter: ${JSON.stringify({name:e.projectName||"Not specified",description:e.projectDescription||"Not specified",manager:e.projectManager||"Not specified",startDate:e.startDate||"Not specified",endDate:e.endDate||"Not specified",objectives:(s=e.objectives)!=null&&s.length?e.objectives:["Not specified"],stakeholders:(l=e.stakeholders)!=null&&l.length?e.stakeholders:["Not specified"]})}`}):r.push({role:"developer",content:"No project charter information available."}),r.push({role:"developer",content:"Tables are represented in JSON (an Array containing row, each row being an array itself with the columns as the fields). An empty Table always contains the first row with the headings. The first column consists of all the first fields of all the first rows."});let n=JSON.stringify(j);r.push({role:"developer",content:"About task table fields: Min, Likely and Max are estimated hours of effort to complete the task. Resources defines which resources can be used to complete the task. If multiple options exist, they can be separated by commas. If multiple resources are required together, an & can be used to connect them. The ampersand binds stringer than the comma. Predecessors is a list of Ids separated by commas which must be left empty if none is pressent. Progress is an integer between 0 and 100. When you add or remove tasks, also think about adjusting the dependencies of predecessor tasks and successors. It might not be obvious, but it is important."}),r.push({role:"developer",content:`The current task table:
`+n});let h=JSON.stringify(S);r.push({role:"developer",content:"About resource table fields: The first column contains dates and every other column contains the available hours one ressource can work for the project."}),r.push({role:"developer",content:`The current resource table:
`+h});let c=await d.sendToGPT(r,I);console.log("response",c),g.update(p=>(p.push(c.message),p)),c.message.tool_calls!==void 0&&c.message.tool_calls.length>0&&J(c.message.tool_calls).forEach(N=>{g.update(k=>(k.push(N),k))}),o++,t=c.message.content}return t}i.record=async()=>{i.update(o=>({...o,isRecording:!0,status:"recording"})),await d.record(),i.update(o=>({...o,isRecording:!1,status:"transcribing"}));let a=await d.transcribe();g.update(o=>(o.push({role:"user",content:a}),o)),console.log("conversation:",m),i.update(o=>({...o,isThinking:!0,status:"thinking"}));let t=await A(m);if(i.update(o=>({...o,isThinking:!1})),t!=null){console.log("GPT-Antwort:",t),i.update(s=>({...s,isSpeaking:!0,status:"speaking"}));let o=await d.speak(t);console.log("the promise looks like this:",o),i.update(s=>({...s,isSpeaking:!1,status:"idle"}))}else i.update(o=>({...o,status:"idle"}))};i.handleTextInput=async()=>{i.update(t=>({...t,isThinking:!0,status:"thinking"}));let a=await A(m);if(i.update(t=>({...t,isThinking:!1})),a!=null){console.log("GPT-Antwort:",a),i.update(o=>({...o,isSpeaking:!0,status:"speaking"}));let t=await d.speak(a);console.log("the promise looks like this:",t),i.update(o=>({...o,isSpeaking:!1,status:"idle"}))}else i.update(t=>({...t,status:"idle"}))};i.stop=()=>{d.stopRecording(),i.update(a=>({...a,isRecording:!1,isThinking:!1,isSpeaking:!1,status:"idle"}))};i.stopSpeaking=()=>{d.stopPlayback()};P.subscribe(a=>{d.setApiKey(a)});export{T as a,P as b,g as c,i as d};
