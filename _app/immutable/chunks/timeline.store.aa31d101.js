import{d as h}from"./index.2391f01a.js";import{l as g,c as p,r as v}from"./criticalPath.store.3b292004.js";import{g as S}from"./gantt.store.e33e3c75.js";function w(r,e,i,n){let o=r.slice(0,i),t=e.slice(i);return this.validateAndMerge(o,t,n)}function A(r,e,i){let n=r;e.forEach((s,l)=>{n=this.pushAfterPredecessors(s,n,i)});let o=new Map(Object.entries(i));n=n.filter((s,l,a)=>{let c=String(s.id),u=o.has(c);return o.delete(c),u});let t=Array.from(o.keys()).map(s=>({id:s}));return n=n.concat(t),n}function d(r,e,i){let n=i[r.id].predecessors;return n===void 0&&(n=[]),n.forEach((o,t,s)=>{let l=!1;for(let a=e.length-1;a>=0;a--)if(e[a].id===o){l=!0;break}l===!1&&(e=d({id:o},e,i))}),e.push(r),e}function m(r,e,i,n){return[r[e],r[i]]=[r[i],r[e]],r=this.validateAndMerge([],r,n),r}function L(r){let e=r.slice(0,1),i=r.slice(1).map(n=>{let o=n.slice(0,1);return o=o.concat(n.slice(1).map(t=>({free:g(t),allocations:[]}))),o});return e=e.concat(i),e}function R(r){let e=Object.keys(r).map(i=>({id:i}));return e=this.validateAndMerge([],e,r),e}function G(r,e){return e[r].predecessors.reduce((o,t)=>{if(e[t].progress==="100 %"||e[t].progress==="100 %")return o;if(e[t].endDate===void 0)throw console.log("a predecessors has not been allocated, something is wrong..."),"predecessor not allocated";return o===void 0||e[t].endDate>o?e[t].endDate:o},void 0)}function N(r,e){return e.map(n=>n.map(t=>{let s=r[0].indexOf(t);return s<0&&(console.log("The resource",t,"in task",id,"is not defined in the resource table"),alert("The resource "+t+" in task "+id+" is not defined in the resource table")),s}))}function D(r,e,i,n){let o=0,t=r[e][i].free;if(isNaN(t)||t===0)return!1;for(;n>0;){if(e+o>=r.length)return!1;if(t=r[e+o][i].free,isNaN(t)){o++;continue}if(t===0)return!1;n-=t,o++}return!0}function O(r,e,i,n){return e.reduce((t,s)=>{let l=!0;for(let a=0;a<s.length;a++)if(!this.slotAvailable(r,i,s[a],n)){l=!1;break}return l&&t.push({resIdList:s,row:i}),t},[])}function F(r,e,i,n){let o,t=!0;for(let s=1;s<r.length;s++){if((i===void 0||r[s-1][0]===i)&&(t=!1),t)continue;let l=this.availableSlotsForResourceLists(r,e,s,n);if(l.length>0){o=l[0];break}}return o}function P(r,e,i,n){let o=r[n.row][0],t,s;return n.resIdList.forEach(l=>{let a=e[i].expected;for(let c=n.row;c<r.length;c++){let u=r[c][l].free;if(!isNaN(u))if(a>u)a-=u,r[c][l].allocations.push({task:i,amount:u}),r[c][l].free=0;else{r[c][l].free-=a,r[c][l].allocations.push({task:i,amount:a}),a=0,s=c,t=r[c][0];break}}}),e[i].startDate=o,e[i].endDate=t,e[i].resIdList=e[i].resIdList.concat(n.resIdList),e[i].firstRow=n.row,e[i].lastRow=s,[r,e]}function T(r,e,i){return i=this.validateAndMerge([],i,e),i.forEach(n=>{if(e[n.id].progress==="100 %"||e[n.id].progress==="100 %")return;let o=this.earliestStartAllocation(n.id,e),t=this.convertResourcesToIdList(r,e[n.id].res),s=this.findFreeSlot(r,t,o,e[n.id].expected);if(s===void 0){let l="Task "+n.id+" could not be allocated. Please provide more resources or adjust constraints.";console.error(l),alert(l)}[r,e]=this.writeAllocations(r,e,n.id,s)}),[r,e]}function b(r,e,i){let n={iterations:20,size:10,crossover:.3,mutation:.3,webWorkers:!0,skip:5},o={timetable:r,taskMap:e},t=Genetic.create();t.optimize=Genetic.Optimize.Minimize,t.select1=Genetic.Select1.Tournament2,t.select2=Genetic.Select2.Tournament2,t.initialGeneration=R,t.createChild=w,t.validateAndMerge=A,t.pushAfterPredecessors=d,t.mutateSwap=m,t.earliestStartAllocation=G,t.convertResourcesToIdList=N,t.slotAvailable=D,t.availableSlotsForResourceLists=O,t.findFreeSlot=F,t.writeAllocations=P,t.allocateGeneration=T,t.seed=function(){return this.initialGeneration(this.userData.taskMap)},t.mutate=function(s){let l=Math.floor(Math.random()*s.length),a=Math.floor(Math.random()*s.length);return this.mutateSwap(s,l,a,this.userData.taskMap)},t.crossover=function(s,l){let a=s.length,c=Math.floor(Math.random()*a),u=this.createChild(s,l,c,this.userData.taskMap);return[this.createChild(l,s,c,this.userData.taskMap),u]},t.fitness=function(s){let l=JSON.parse(JSON.stringify(this.userData.timetable)),a=JSON.parse(JSON.stringify(this.userData.taskMap));return[l,a]=this.allocateGeneration(l,a,s),Object.values(a).reduce((u,f)=>(f.lastRow>u&&(u=f.lastRow),u),-1)},t.generation=function(s,l,a){},t.notification=function(s,l,a,c){c&&([r,e]=this.allocateGeneration(r,e,s[0].entity),console.log("genetic finished"),i(r,e))},console.log("starting genetic"),t.evolve(n,o)}const j=h([p,v],([r,e],i)=>{let n=L(e);if(r.map===void 0){console.log("criticalPath not calculated yet"),i(n);return}let o=JSON.parse(JSON.stringify(r));console.log("gantt",o),b(n,o.map,(t,s)=>{o.map=s,S.set(o),i(t)}),i(n)},[[],[]]);export{j as t};
