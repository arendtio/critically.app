var b=(a,e,r)=>{if(!e.has(a))throw TypeError("Cannot "+r)};var l=(a,e,r)=>(b(a,e,"read from private field"),r?r.call(a):e.get(a)),h=(a,e,r)=>{if(e.has(a))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(a):e.set(a,r)},E=(a,e,r,t)=>(b(a,e,"write to private field"),t?t.call(a,r):e.set(a,r),r);var u=(a,e,r)=>(b(a,e,"access private method"),r);import{w as M}from"./index.6deb0bed.js";import{g as z}from"./tables.store.e04557b4.js";import{N as _}from"./scheduler.8fe615de.js";var n,m,d,x,y,O,w,S,T,F,$,A;class B{constructor(){h(this,y);h(this,w);h(this,T);h(this,$);h(this,n,void 0);h(this,m,[]);h(this,d,[]);h(this,x,void 0);E(this,n,new Map),E(this,x,new Map)}addTask(e,r,t,s,c,i,p,f){if(t=j(t),s=j(s),c=j(c),isNaN(t)||isNaN(s)||isNaN(c))throw new Error(`Invalid duration values for task "${e}": min=${t}, likely=${s}, max=${c}`);i=i.split(",").map(g=>g.split("&").map(L=>L.trim()));let o=p.split(",").map(g=>g.trim()).filter(g=>g!=="");o.forEach(g=>{if(g===e.toString())throw new Error(`Task "${e}" cannot have itself as a predecessor.`)});let N=Math.round((t+s*4+c)/6),P={id:e,name:r,min:t,likely:s,max:c,res:i,resIdList:[],predecessors:new Set(o),successors:new Set,progress:f,earlyCol:1,es:0,ef:0,ls:0,lf:0,slack:-1,expected:N};l(this,n).set(e,P)}getTask(e){return l(this,n).get(e)}calc(){return u(this,y,O).call(this),u(this,T,F).call(this),u(this,$,A).call(this),{starts:l(this,m),map:Object.fromEntries(l(this,n)),ends:l(this,d)}}}n=new WeakMap,m=new WeakMap,d=new WeakMap,x=new WeakMap,y=new WeakSet,O=function(){l(this,n).forEach(e=>{e.predecessors.forEach(r=>{if(!l(this,n).has(r))throw new Error(`Task "${e.id}" references predecessor "${r}" which does not exist.`)})}),l(this,n).forEach(e=>{e.predecessors.forEach(r=>{l(this,n).get(r).successors.add(e.id)})}),E(this,m,[...l(this,n).values()].filter(e=>e.predecessors.size===0).map(e=>e.id)),E(this,d,[...l(this,n).values()].filter(e=>e.successors.size===0).map(e=>e.id))},w=new WeakSet,S=function(e,r,t,s){if(t.has(e))return;t.add(e);let c=l(this,n).get(e);c[r].forEach(i=>{u(this,w,S).call(this,i,r,t,s)}),c=s(c),l(this,n).set(c.id,c)},T=new WeakSet,F=function(){let e=new Set;l(this,d).forEach(r=>{u(this,w,S).call(this,r,"predecessors",e,t=>{let s=[...t.predecessors].map(i=>l(this,n).get(i)).reduce((i,p)=>i<p.ef?p.ef:i,0),c=[...t.predecessors].map(i=>l(this,n).get(i)).reduce((i,p)=>i<p.earlyCol?p.earlyCol:i,0);return t.earlyCol=c+1,t.es=s+1,t.ef=t.es+t.expected-1,t})})},$=new WeakSet,A=function(){let e=Math.max(...l(this,d).map(t=>l(this,n).get(t).ef)),r=new Set;l(this,m).forEach(t=>{u(this,w,S).call(this,t,"successors",r,s=>{let c=[...s.successors].map(i=>l(this,n).get(i)).reduce((i,p)=>i<p.ls?i:p.ls,e+1);return s.lf=c-1,s.ls=s.lf-s.expected+1,s.slack=s.ls-s.es,s})})};const v=M({}),C=M(void 0);function j(a,e){e===void 0&&(e=navigator.languages&&navigator.languages.length?navigator.languages[0]:navigator.language);let[,r,,,,t]=1111.1.toLocaleString(e);return a=Array.from(""+a,s=>s===r?"":s===t?".":s).join(""),parseFloat(a)}v.reset=()=>v.set({});C.reset=()=>C.set(void 0);v.calculate=function(){C.set(void 0);let a;z("tasks").update(o=>(a=o,o));let r=new B,t=[];if(a.getAllIds().forEach(o=>{let N=a.getRow(o);try{r.addTask(...N)}catch(P){t.push(P.message)}}),t.length>0){const o=`Please fix the following issues:

`+t.join(`
`);alert(o);return}console.log("Starting calculation");let s;try{s=r.calc()}catch(o){alert("Error during critical path calculation: "+o.message);return}let c=new Map;for(var i in s.map)if(Object.prototype.hasOwnProperty.call(s.map,i)){let o=s.map[i];o.predecessors=[...o.predecessors],c.set(o.id,o)}s.map=Object.fromEntries(c);const f=_(v).map||{};console.log("Existing positions before preservation:",f),Object.keys(s.map).forEach(o=>{console.log(`Task ${o} - Before:`,s.map[o]),f[o]?(console.log(`Existing position for ${o}:`,f[o]),s.map[o].x=f[o].x,s.map[o].y=f[o].y,console.log(`Task ${o} - After:`,s.map[o])):console.log(`Task ${o} - No existing position found`)}),console.log("Final positions after preservation:",s.map),console.log("Finished calculation: ",JSON.stringify(s)),v.set(s)};export{v as c,C as d,j as l};
